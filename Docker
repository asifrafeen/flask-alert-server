# ===========================
# Stage 1: Builder
# ===========================
FROM python:3.12-alpine AS builder

# Set working directory
WORKDIR /app

# Install system dependencies (for pip and build tools)
RUN apk add --no-cache build-base

# Copy Python dependencies
COPY requirements.txt .

# Install dependencies into a temporary folder
RUN pip install --no-cache-dir --prefix=/install -r requirements.txt

# Copy application code
COPY . .

# Create log directory (like your Node example)
RUN mkdir -p /app/log


# ===========================
# Stage 2: Runtime
# ===========================
FROM python:3.12-alpine

# Set working directory
WORKDIR /app

# Copy dependencies from builder
COPY --from=builder /install /usr/local

# Copy app code
COPY --from=builder /app /app

# Expose Flask port
EXPOSE 5000

# Environment variables (adjust as needed)
ENV FLASK_APP=app.py \
    FLASK_RUN_HOST=0.0.0.0 \
    PYTHONUNBUFFERED=1

# Run Flask app
CMD ["python", "app.py"]
